# 20240103 TIL

## ****ìë°” ORM í‘œì¤€ JPA í”„ë¡œê·¸ë˜ë° - ê¸°ë³¸í¸****

### ë‹¨ë°©í–¥ ë§¤í•‘(feat.ê°ì²´ì™€ í…Œì´ë¸”ì˜ ê°„ê·¹1)

- í…Œì´ë¸”: ì™¸ë˜í‚¤ë¡œ ì¡°ì¸ì„ ì‚¬ìš©í•´ì„œ ì—°ê´€ëœ í…Œì´ë¸”ì„ ì°¾ìŒ
- ê°ì²´: ì°¸ì¡°ë¥¼ ì‚¬ìš©í•´ì„œ ì—°ê´€ëœ ê°ì²´ ì°¾ìŒ
- FKë¥¼ ê·¸ëŒ€ë¡œ ê°ì²´ì— ì„¤ê³„(x) â†’ ì—°ê´€ê´€ê³„ê°€ ì—†ì–´ì„œ ì‹ë³„ìë¥¼ ê³„ì† êº¼ë‚´ì•¼ í•¨ â†’ ë²ˆê±°ë¡­/ê°ì²´ì§€í–¥ì X
- FKê°€ ë˜ëŠ” ê°ì²´ë¥¼ ì°¸ì¡°í•˜ë„ë¡ (o) + jpaê°€ ê´€ê³„ ì´í•´í•˜ë„ë¡ ì—°ê´€ê´€ê³„ ë§¤í•‘

### ì–‘ë°©í–¥ ë§¤í•‘(feat.ê°ì²´ì™€ í…Œì´ë¸”ì˜ ê°„ê·¹2)

- ê°ì²´ ì—°ê´€ê´€ê³„ (ë‹¨ë°©í–¥)2ê°œ
    - íšŒì› â†’ íŒ€(ë‹¨ë°©í–¥)
    - íŒ€ â†’ íšŒì›(ë‹¨ë°©í–¥)
- í…Œì´ë¸” ì—°ê´€ê´€ê³„ 1ê°œ(ì–‘ë°©í–¥)

![/Users/choiyurim/Desktop/git/TIL/images/20240103_images](https://github.com/Choiulmu/TIL/blob/main/images/20240103_images/%EC%96%91%EB%B0%A9%ED%96%A5.png)

Q. Memberì˜ Team ì†Œì†ì„ ë°”ê¿€ë•Œ ì–´ë–¤ ê²ƒìœ¼ë¡œ ë°”ê¿”ì•¼ í•˜ë‚˜?

ë°©ë²•1) Memberê°€ ì°¸ì¡°í•˜ëŠ” Teamì„ ë°”ê¾¼ë‹¤

ë°©ë²•2) Teamì— ì†Œì†í•˜ëŠ” membersë¥¼ ë°”ê¾¼ë‹¤

â‡’ ë‘ ê°ì²´ ì¤‘ í•˜ë‚˜ë¥¼ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ìœ¼ë¡œ ì§€ì •
â‡’ ì—°ê´€ê´€ê³„ì˜ ì£¼ì¸ë§Œ ì™¸ë˜í‚¤ ê´€ë¦¬(ë“±ë¡, ìˆ˜ì •)
â‡’ ì£¼ì¸ ì•„ë‹Œìª½ì€ ì½ê¸°ë§Œ

### ì–‘ë°©í–¥ ë§¤í•‘ ê·œì¹™

- ì—°ê´€ê´€ê³„ ì£¼ì¸: ì™¸ë˜í‚¤ ê´€ë¦¬(ë“±ë¡, ìˆ˜ì •) = â€œì™¸ë˜í‚¤ê°€ ìˆëŠ” ê³³â€
- ì—°ê´€ê´€ê³„ ì£¼ì¸ ì•„ë‹Œ ìª½: ì½ê¸° â†’ mappedBy ì†ì„±ìœ¼ë¡œ ì£¼ì¸ ì§€ì •

### ì–‘ë°©í–¥ ë§¤í•‘ ê´€ë ¨ ì‹¤ìˆ˜

1) ì—°ê´€ê´€ê³„ ì£¼ì¸ = ì™¸ë˜í‚¤ ê´€ë¦¬(ë“±ë¡, ìˆ˜ì •) â†’ ê°„í˜¹ ì£¼ì¸ì— ê°’ì„ ì…ë ¥í•˜ì§€ ì•Šê³  ê°’ì´ ì•ˆ ë“¤ì–´ê°”ë‹¤ê³  ì†ìƒí•´í•¨

```java
//Wrong
Member member = new Member();
member.setName("ìµœìœ ë¦¼");
em.persist(member);

Team devTeam = new Team();
devTeam.setName("ê°œë°œíŒ€");
devTeam.getMembers().add(member);
em.persist(devTeam);
```

```java
//Right
Team devTeam = new Team();
devTeam.setName("ê°œë°œíŒ€");
em.persist(devTeam);

Member member = new Member();
member.setName("ìµœìœ ë¦¼");
member.setTeam(devTeam);
em.persist(member);
```

2) ìˆœìˆ˜ ê°ì²´ ìƒíƒœë¥¼ ê³ ë ¤í•´ì„œ í•­ìƒ ì–‘ìª½ì— ê°’ì„ ì„¤ì •í•˜ì

```java
public class JpaMain {
    public static void main(String[] args){
        EntityManagerFactory emf = Persistence.createEntityManagerFactory("hello");

        EntityManager em = emf.createEntityManager();

        EntityTransaction tx = em.getTransaction();
        tx.begin();

        try{
            Team devTeam = new Team();
            devTeam.setName("ê°œë°œíŒ€");
            em.persist(devTeam);

            Member member = new Member();
            member.setName("ìµœìœ ë¦¼");
            member.setTeam(devTeam);
            em.persist(member);

            em.flush();
            em.clear();

            Member findMember = em.find(Member.class, member.getId());
            List<Member> memberList = findMember.getTeam().getMembers();
            for(Member m : memberList){
                System.out.println(m.getName());
            }

            tx.commit();
        } catch(Exception e){
            tx.rollback();
        } finally {
            em.close();
        }
        emf.close();
    }
```

- ìœ„ ì¡°íšŒ ê¸°ëŠ¥ì´ ì˜¬ë°”ë¥´ê²Œ ì‘ë™í•˜ëŠ” ì´ìœ ëŠ” em.flush()ì™€ em.clear()ë•Œë¬¸
- em.persist(entity)ëŠ” ë‘˜ì˜ ì—°ê´€ê´€ê³„ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šê³  ê°ê°ì˜ ê°ì²´idì™€ entityë¥¼ ì €ì¥
- ë‘˜ì˜ ì—°ê´€ ê´€ê³„ëŠ” DBê¹Œì§€ ë“¤ì–´ê°€ì•¼ ì•Œ ìˆ˜ ìˆìŒ - persist()ì—ì„œëŠ” insertì¿¼ë¦¬ ì•ˆ ë‚ ë¦¼
â‡’ JPAëŠ” ë‘˜ì˜ ì—°ê´€ ëª°ë¼..
â‡’ ì¤‘ê°„ì— flush()ì™€ clear()ë¥¼ í†µí•´ 1ì°¨ ìºì‹±ì„ í•œë²ˆ ë¹„ì›€ - DBì—ì„œ ë‘ ê°ì²´ë¥¼ ì¡°íšŒí•´ ì—°ê´€ ê´€ê³„ íŒŒì•… & ì¡°íšŒ
â‡’ ìˆœìˆ˜ ê°ì²´ ìƒíƒœ ê³ ë ¤í•´ì„œ ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ì˜ ê²½ìš°, ì–‘ìª½ì— ê°’ ì„¤ì •
â‡’ How to? ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì†Œë“œ

### ì—°ê´€ê´€ê³„ í¸ì˜ ë©”ì†Œë“œ

- ë‘˜ ì¤‘ í•œìª½ì—ë§Œ ë„£ì„ ê²ƒ(ì–´ë”” ë„£ì–´ì•¼ í• ì§€ëŠ” ì‹¤ë¬´ ìƒí™©ë§ˆë‹¤ dif)
    
    ```java
    package jpabook.jpashop.domain;
    
    import jakarta.persistence.*;
    import lombok.Getter;
    import lombok.Setter;
    
    @Entity
    @Getter @Setter
    public class Member {
    
        @Id @GeneratedValue
        @Column(name = "MEMBER_ID")
        private Long id;
    
        private String name;
    
        @ManyToOne
        @JoinColumn(name = "TEAM_ID")
        private Team team;
    
        private String city;
    
        private String street;
    
        private String zipcode;
    
        public Member() {
        }
    
        public void setTeam(Team team) {
            this.team = team;
            team.getMembers().add(this);
        }
    }
    ```
    

### ì–‘ë°©í–¥ ë§¤í•‘ ì£¼ì˜ì 

ì–‘ë°©í–¥ ë§¤í•‘ì‹œ ë¬´í•œ ë£¨í”„ ì¡°ì‹¬ 

- lombokì˜ toString() ì“°ì§€ë§ˆ
- Controllerì— ì ˆëŒ€ Entity ì ˆëŒ€ ë°˜í™˜í•˜ì§€ë§ˆë¼
    - ë¬´í•œë£¨í”„ ë°œìƒ ê°€ëŠ¥
    - Entity ë³€ê²½í•˜ëŠ” ìˆœê°„ API ìŠ¤í™ì´ ë°”ë€Œì–´ë²„ë¦¼
    - í•´ê²°ë°©ì•ˆ) EntityëŠ” DTOë¡œ ë³€í™˜í•´ì„œ ë°˜í™˜í•´ë¼

### ì–‘ë°©í–¥ ë§¤í•‘ ì •ë¦¬

- ì´ˆê¸° ì„¤ê³„ì‹œ ë‹¨ë°©í–¥ ë§¤í•‘ìœ¼ë¡œ ëë‚´ë¼.(â­ï¸)
- ë‹¨ë°©í–¥ ë§¤í•‘ë§Œìœ¼ë¡œë„ ì´ë¯¸ ì—°ê´€ê´€ê³„ ë§¤í•‘ì€ ì™„ë£Œ
- ì–‘ë°©í–¥ ë§¤í•‘ì€ ê·¸ì € ë°˜ëŒ€ ë°©í–¥ìœ¼ë¡œ ì¡°íšŒ(ê°ì²´ ê·¸ë˜í”„ íƒìƒ‰)ê¸°ëŠ¥ì´ ì¶”ê°€ëœ ê²ƒ ë¿ (only ê°œë°œìƒ í¸ì˜ë¥¼ ìœ„í•œ ê²ƒ)
- ì‹¤ë¬´ì—ì„œëŠ” JPQLì—ì„œ ì—­ë°©í–¥ íƒìƒ‰í•  ì¼ ë§ìŒ
- **âˆ´**  ì´ˆê¸° ë‹¨ë°©í–¥ ë§¤í•‘ë§Œ ì˜í•˜ê³  ì–‘ë°©í–¥(mappedBy)ì€ í•„ìš”í•  ë•Œ ì¶”ê°€(í…Œì´ë¸”ì— ì˜í–¥X)
- ì—°ê´€ê´€ê³„ ì£¼ì¸ = ì™¸ë˜í‚¤(FK)ë¥¼ ì¥” ìª½

---

- í…Œì´ë¸”ì€ ë‹¤(å¤š)ìª½ì— ì™¸ë˜í‚¤(FK)ë¥¼ ë‘ì–´ì•¼ í•œë‹¤.

### ë‹¤ëŒ€ì¼(N:1)

- FKë¥¼ ë‹¤(å¤š)ìª½ì´ ê°€ì§ â†’ FKê°€ì§„ìª½ì¸ ì£¼ì¸
- ë‹¤ëŒ€ì¼ ë‹¨ë°©í–¥: FKê°€ì§„ ìª½(ì£¼ì¸)ì— @ManyToOne + @JoinColumn
- ë‹¤ëŒ€ì¼ ì–‘ë°©í–¥: FKê°€ì§„ ìª½(ì£¼ì¸)ì— @ManyToOne + @JoinColumn â†” ë°˜ëŒ€ìª½(ì£¼ì¸X)ì— mappedBy

### ì¼ëŒ€ë‹¤(1:N)

- ê°ì²´ ì¤‘ ì¼(1)ì´ FKë¥¼ ê°€ì¡Œë‹¤ - ì¼(1) ìª½ì´ ì£¼ì¸ â† ë¶ˆì¼ì¹˜ â†’ í…Œì´ë¸”ì€ ë‹¤(å¤š)ìª½ì— ì™¸ë˜í‚¤(FK)
- ì¼ëŒ€ë‹¨ ë‹¨ë°©í–¥
    - ë°˜ëŒ€í¸ í…Œì´ë¸”ì˜ ì™¸ë˜í‚¤ë¥¼ ê´€ë¦¬ 
    â†’ ë‹¨ì : ì—°ê´€ê´€ê³„ ê´€ë¦¬ë¥¼ ìœ„í•´ ì¶”ê°€ë¡œ UPDATE ì¿¼ë¦¬ ë‚˜ê°
    â†’ JPA ì˜ ëª¨ë¥´ë©´ â€œì–´? ë‚œ TEAMí…Œì´ë¸” ê±´ë“¤ì˜€ëŠ”ë° ì™œ MEMBERê°€ updateë˜ëŠ”ê±°ì•¼?!?â€ğŸ˜±
    - @JoinColumn ì‚¬ìš© or ì¡°ì¸ í…Œì´ë¸” ë°©ì‹(ì¤‘ê°„ì— í…Œì´ë¸” ì¶”ê°€)
        
        
        ![https://github.com/Choiulmu/TIL/blob/main/images/20240103_images/%EC%9D%BC%EB%8C%80%EB%8B%A4.png](https://github.com/Choiulmu/TIL/blob/main/images/20240103_images/%EC%9D%BC%EB%8C%80%EB%8B%A4.png)
        
        ```java
        try{
             Member member = new Member();
             member.setName("ìµœìœ ë¦¼");
             em.persist(member);
        
             Team team = new Team();
             team.setName("ì½”ë“œí”„ë ˆì†Œ ë°±ì—”ë“œíŒ€");
             
        		//teamí…Œì´ë¸”ì— Memberì—†ìœ¼ë‹ˆ Update ì¿¼ë¦¬ ì¶”ê°€ë¡œ
        		 team.getMembers().add(member);
             em.persist(team);
        
             tx.commit();
        }
        ```
        
- ì¼ëŒ€ë‹¤ ì–‘ë°©í–¥
    - ì´ëŸ° ë§¤í•‘ ê³µì‹ì ìœ¼ë¡œ ì¡´ì¬X
    - @JoinColumn(insertable=false, updatable=false) â†’ ì†ì„±ì„ ì–µì§€ë¡œ ì„¤ì •í•´ì„œ Read-Only
    - ê²°ê³¼ì ìœ¼ë¡œëŠ” ì–‘ìª½ ë‹¤ @JoinColumnì„ ê±¸ê²Œ ë¨

### ì¼ëŒ€ì¼(1:1)

- ì£¼í…Œì´ë¸”ì´ë‚˜ ëŒ€ìƒ í…Œì´ë¸” ì¤‘ ì™¸ë˜í‚¤(FK) ì•„ë¬´ë°ì„œë‚˜ ë‘˜ ìˆ˜ ìˆë‹¤.
- ë‹¨, ì™¸ë˜ í‚¤ì— ë°ì´í„°ë² ì´ìŠ¤ ìœ ë‹ˆí¬(UNI)ì œì•½ì¡°ê±´ ì¶”ê°€
- ì£¼í…Œì´ë¸”ì— FKê°€ ìˆëŠ” ì¼ëŒ€ì¼ ë‹¨ë°©í–¥

![/Users/choiyurim/Desktop/git/TIL/images/20240103_images](https://github.com/Choiulmu/TIL/blob/main/images/20240103_images/%EC%9D%BC%EB%8C%80%EC%9D%BC%EB%8B%A8.png)

- ì¼ëŒ€ì¼ ë‹¨ë°©í–¥
: FKê°€ì§„ ìª½(ì£¼ì¸)ì— @OneToOne + @JoinColumn
- ì¼ëŒ€ì¼ ì–‘ë°©í–¥
: FKê°€ì§„ ìª½(ì£¼ì¸)ì— @OneToOne + @JoinColumn 
  â†” ë°˜ëŒ€ìª½(ì£¼ì¸X)ì— mappedBy
- ëŒ€ìƒ í…Œì´ë¸”ì— FKê°€ ìˆëŠ” ì¼ëŒ€ì¼ ë‹¨ë°©í–¥ = ë°©ë²•X
- ì£¼í…Œì´ë¸”ì— FKê°€ ìˆëŠ”/ëŒ€ìƒ í…Œì´ë¸”ì— FKê°€ ìˆëŠ” ì¼ëŒ€ì¼ ì–‘ë°©í–¥(= ê·¸ëƒ¥ ë‚´ê°€ ë‚´êº¼ ê´€ë¦¬í•´!)

![/Users/choiyurim/Desktop/git/TIL/images/20240103_images](https://github.com/Choiulmu/TIL/blob/main/images/20240103_images/%EC%9D%BC%EB%8C%80%EC%9D%BC%EC%96%911.png)

![/Users/choiyurim/Desktop/git/TIL/images/20240103_images](https://github.com/Choiulmu/TIL/blob/main/images/20240103_images/%EC%9D%BC%EB%8C%80%EC%9D%BC%EC%96%912.png))

- @OneToOneì£¼í…Œì´ë¸”ì— ì™¸ë˜í‚¤ê°€ ìˆì„ ë•Œ
    - ì£¼í…Œì´ë¸”ì— ì™¸ë˜í‚¤ ë‘ê³  ëŒ€ìƒ í…Œì´ë¸” ì°¾ìŒ â†’ ì£¼í…Œì´ë¸”ë§Œ ì¡°íšŒí•´ë„ ëŒ€ìƒ í…Œì´ë¸”ì— ë°ì´í„° ìˆëŠ”ì§€ í™•ì¸O
    - ê°ì²´ ì§€í–¥ ê°œë°œì ì„ í˜¸
    - JPA ë§¤í•‘ í¸ë¦¬(B. FKìˆëŠ” í…Œì´ë¸” = ì£¼í…Œì´ë¸”)
    - ë‹¨ì : ê°’ ì—†ìœ¼ë©´ ì™¸ë˜í‚¤ì— null í—ˆìš©
- @OneToOneëŒ€ìƒí…Œì´ë¸”ì— ì™¸ë˜í‚¤ê°€ ìˆì„ ë•Œ
    - ì „í†µì ì¸ ë°ì´í„° ë² ì´ìŠ¤ ê°œë°œìê°€ ì„ í˜¸
    - ìœ„ ê²½ìš° ì£¼í…Œì´ë¸”(Member), ëŒ€ìƒí…Œì´ë¸”(Locker)ì¸ë° ê´€ê³„ë¥¼ ì¼ëŒ€ë‹¤ë¡œ ë³€ê²½í•´ì•¼í•  ë•Œ GOOD
    (B. í…Œì´ë¸”ì€ ë‹¤(å¤š)ìª½ì— ì™¸ë˜í‚¤(FK)ë‘ë‹ˆê¹Œ)
    - ë‹¨ì : í”„ë¡ì‹œ ê¸°ëŠ¥ í•œê³„ë¡œ ì§€ì—° ë¡œë”©ìœ¼ë¡œ ì„¤ì •í•´ë†”ë„ ì¦‰ì‹œ ë¡œë”©ë¨
